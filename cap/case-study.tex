\chapter{Case study: geostatistics on neolithic settlements in Tavoliere}

    \begin{chaptersum}
        Sommario in italiano
    \end{chaptersum}

    The geostatistical system described in this chapter has been structured using the processed spatial data collected during almost ten years of surveying of the settlements in the Tavoliere plain. The existence of buried settlements ranging from neolithic period to middle ages has been proved by field and aerial surveys and by historical records. Given the variety and widespread distribution of the settlements across about \SI{150}{\hectare}, aerial and geophysical methods assured the best results, and heavily contributed to collect the data useful to an accurate landscape archaeology study \cite[pp.~45--48]{remote-ciminale}.

    \section{General features of the settlements}
        As extensively reported in literature \cite{intro-tavoliere}, the 256 sites form one of the densest concentrations of prehistoric settlements in Europe, lying within a plain approximately \SI{50}{\kilo\meter} by \SI{80}{\kilo\meter} at its broadest and longest points. The natural boundaries of this area are marked from rivers Fortore and Ofanto --- north and south --- and the Gulf of Manfredonia and Appennine foothills --- east and west.\\
        The settlements are large or small villages, normally surrounded by one or more ditches, with the interior generally filled with a number of internal compounds. The majority of the sites occupied level ground. Refer to published materials for further details.

        \subsection{Published data and the work of J. D. B. Jones}

            \subsubsection{Spatial analysis}

        \subsection{Modern spatial investigations}
            \input{tab/tab-layers}
            After the post-processing, all the data have been placed in a GIS environment, currently containing XXX different raster layers and a single vector layer (\fref{tab:layers}). These vector layers refer to the latest study in chronological order, carried out by dott.ssa Angela Laterza in 2013,
            % TODO: add bib reference to Angelica's thesis
            who completely digitized the structures contained in 23 neolithic settlements. The whole digitalization process took as long as 320 hours and consisted in manually tracing the borders of the visible structures (\emph{ditches} and \emph{compounds}) and, as a separate geometry, the respective area for each of them; the operator has been employed for about two months, and has produced about 1300 geometries; \fref{fig:scheme-derive} shows the whole process.

            \begin{figure}[htp]
                \resizebox{1.1\textwidth}{!}{%
                    \input{tab/dot-geo-workflow}
                }
                \caption[Data deriving workflow for the Tavoliere project]{Data derivation workflow for the case study. Raster layers (\textsf{rs}) are the source of all derived vector data (\textsf{vt}). Bold lines represents a manual process, while dashed ones an automated process. Perimeter as numeric value have been calculated and saved in derived geometries.}
                \label{fig:scheme-derive}
            \end{figure}

    \section{The GIS approach to statistics}
        The first step in statistical analysis at any level is to build a suitable set of data. In this case study, vector shapes of ditches and compounds can be considered as \emph{primary} data, while area geometries as \emph{derived} data.
        The statistical and spatial approach to the study of neolithic --- or, in general, prehistoric --- settlements data is well documented in literature \cite{arch-location-model}, and the strict relation between the morphology of the natural environment and the ancient societies enforces the use of GIS systems when deriving data.\\
        Moving from the standard geophysical survey workflow to a spatial analysis context during the study of the settlements has generated some necessities, which need to be added to the critical points already defined in \fref{sec:gis-data-management}:

        \begin{description}
            \item[automate derived data creation] the set of derived data may be generated automatically, since it consists of geometries describing the same characteristic on every shape (e.g.\ the internal area of a ditch, for all ditches);
            \item[automate calculations] most of the processes operated on data take a feature of the element (e.g. the perimeter), save it in a database field, retrieves all of them and make calculations; this is a repetitive task which could be done more efficiently;
            \item[platform independent results] the results must be reproducible by any researcher on any platform, and the dynamics of calculations must be public; the structure of the project should enable other researchers to contribute and improve the algorithms.
        \end{description}

        Given that, some objectives have been defined to improve the current workflow and speed up the process, trying to gain in the same time more precision, accuracy and reproducibility; the following subsections will explain how every objective has been achieved in detail.

        \subsection{Development of the open source webGIS interface}
        \pagebreak

        \subsection{Bulk distinguishing ditches and compounds}
            In the current approach, ditches and compounds geometries are distinguished by attributes (the \textsf{Ditch\_comp} field in the Shapefile is respectively set to $1$ or $2$), manually added by the operator to each structure in the Shapefile.

            \begin{wrapfigure}{l}{0.5\textwidth}
                \centering
                \begin{tikzpicture}[x=1mm,y=1mm,scale=0.005]
                    \input{tab/dot-flow-map}
                \end{tikzpicture}
                \caption[Flow chart: the logic of bulk distinguishing ditches and compounds]{If any of the ditches and compounds are sharing the same color (class), class total number $k$ must be changed. At the end, geometry type is saved as an attribute in the shapefile.}
                \label{fig:flow-map}
            \end{wrapfigure}

            This operation has been semi-automated using the Jenks Natural Breaks classification method \cite{jenks1977}. Virtually any classification could have been chosen (quantile, standard deviation), but Jenks Natural Breaks has gained popularity in the last 20 years as a tool for coloring map objects based on objects properties (\emph{choropleth maps}), and it is a well known and tested tool\footnote{Some criticism has recently raised around the use of Jenks Natural Breaks for the classification of \emph{all} kinds of data; alternative solutions have been found for some distributions --- as heavy-tailed ones \cite{jenks-tail} --- but this is not the case, and Jenks has been experimentally proved as the most appropriate choice.}. It aims to present a series of break values that best represent the actual breaks observed in the data as opposed to some arbitrary classificatory scheme (i.e. equal interval); in this way the actual clustering of data values is preserved.

            In the case study, geometries have been classified by perimeter values (calculated and saved automatically from ditches and compounds shapes). The different coloring of the geometries on the map based on the newly created classes (\fref{fig:jenks-color}) helps the user to distinguish ditches from compounds at a glance.

            The process is semi-automated since the user have to manually select the ditches and, if necessary, change the class numbers to have a good fit. The flowchart in \fref{fig:flow-map} reports the logic of the process. At the end, the geometry types are saved as text attribute (literally \textsf{ditch} or \textsf{compound}) in a table containing the results of the processing (one row for each geometry); \fref{tab:jnb-results} shows sample data from the \emph{Anglisano} settlement.

            \begin{table}
                \centering
                \input{tab/tab-rows-anglisano}
                \caption[Sample geometry classification results from Anglisano settlements using Jenk Natural Breaks method]{Sample results from the classification of Anglisano settlement's structures by perimeter using the Jenks Natural Breaks method. The kind of structure is saved as text attribute in the \textsf{type} column. The \textsf{shapefile\_id} column binds the geometries to the respective settlement.}
                \label{tab:jnb-results}
            \end{table}

            \begin{figure}
                \centering
                \rotatebox{180}{
                    \begin{tikzpicture}[x=1mm,y=1mm,scale=0.22]
                        \input{img/jenks}
                    \end{tikzpicture}
                }
                \caption[A choropleth map of \emph{Anglisano} settlement using Jenks Natural Breaks]{A choropleth map of \emph{Anglisano} settlement created using Jenks Natural Breaks algorithm on perimeters automatically derived from geometries (using default value for classes number, 5). Color difference between ditches and compounds is well-rendered.}
                \label{fig:jenks-color}
            \end{figure}

        \subsection{Derive and measure ditches and compounds areas\label{sec:comp-area}}

            \begin{wrapfigure}{l}{0.4\textwidth}
                \centering

                \begin{subfigure}[b]{.33\textwidth}
                    \centering
                    \begin{tikzpicture}[x=1mm,y=1mm,scale=0.041]
                        \input{img/comp-base} 
                    \end{tikzpicture}
                    \caption{Compound's wall surface}
                    \label{fig:comp-wall}
                \end{subfigure}

                \vspace{0.02\textheight}

                \begin{subfigure}[b]{.33\textwidth}
                    \centering
                    \begin{tikzpicture}[x=1mm,y=1mm,scale=0.17]
                        \input{img/comp-hull} 
                    \end{tikzpicture}
                    \caption{Compound's convex hull}
                    \label{fig:comp-hull}
                \end{subfigure}\hfill\\

                \vspace{0.02\textheight}

                \begin{subfigure}[b]{.33\textwidth}
                    \centering
                    \begin{tikzpicture}[x=1mm,y=1mm,scale=0.045]
                        \input{img/comp-area} 
                    \end{tikzpicture}
                    \caption{Compound's internal surface}
                    \label{fig:comp-area}
                \end{subfigure}\hfill\\

                \vspace{0.02\textheight}

                \begin{subfigure}[b]{.33\textwidth}
                    \centering
                    \begin{tikzpicture}[x=1mm,y=1mm,scale=0.07]
                        \input{img/comp-ang-area} 
                    \end{tikzpicture}
                    \caption{Correct internal surface}
                    \label{fig:comp-ang-area}
                \end{subfigure}

                \caption[Deriving compound area from difference between total occupied surface and wall surface]{The area derived from the difference between compound's total occupied surface and the wall surface.}
                \label{fig:comp}

                \vspace{-0.07\textheight}
            \end{wrapfigure}

            After distinguishing ditches from compounds, efforts have been focused on geometric data deriving. One of the most useful operations when analyzing settlements is to calculate the area enclosed in ditches or compounds. Unlike some cases published in literature (e.g.\ the area calculation of rectangular shaped \emph{longhouses} \cite{spatial-south-europe}), the present study has to deal with buried, irregularly shaped, rounded compounds.

            The simplest possible approach to compound's area calculation using standard GIS tools can be summarized as follows:
            
            \begin{enumerate}
                \item generate the convex hull\footnote{In mathematics, the convex hull or convex envelope of a set X of points in the Euclidean plane or Euclidean space is the smallest convex set that contains X \cite{wiki:hull}.} of the compound
                \item subtract the surface occupied by the compound wall from the convex hull area
                \item get the extent of the new geometry (in effect, the extension of the compound's internal area)
            \end{enumerate}

            This method has some drawbacks, mostly the needing to fix the limits of the doorway. A sample result using this approach can be seen in \fref{fig:comp} (compound from the Trecasette settlement). The result shows that it is not suitable for analysis, since doorstep is not set adequately (compare figures \ref{fig:comp-area} and \ref{fig:comp-ang-area}). Iterating over this method on all the compounds would have generated a consistent error so this method has been discarded.

            The problem has been solved applying a common analytical geometry procedure, considering the compound's internal surface as the envelope of the compound wall's points nearest to an inner point (the compound's \emph{centroid}). Compound's inner side points have been captured as the intersection between the compound's wall and a new segment binding the centroid with a point external to the compound. Rotating this external points by \SI{1}{\degree}, the segment itself is rotated and the intersection with the innermost point of the compound's wall is registered. This process is explained in \fref{fig:comp-iter}.
            
            In \fref{fig:comp-iter-1} centroid $C$ is calculated using standard GIS tools from compound's convex hull; point $F$ represents the point on the compound's wall with the maximum distance from $C$; point $B$ is obtained applying a buffer to $F$ ($d_{(C,B)} > d_{(C,F)}$). This last step ensures that the circle $D$ created from $B$ --- using $C$ as center --- is outside the compound's geometry (\fref{fig:comp-iter-2}). A set of points is created on $D$ dividing the perimeter by 360, obtaining one point every \SI{1}{\degree}. In detail, given an angle $\alpha$, a circle $D$ with radius $r=d_{(C,B)}$ and center in $C$ ($x_C, y_C$), a general point $P$ ($x_P, y_P$) on $D$ is defined by:
            %
            \begin{align}
                \label{eq:point-circle}
                x_P &= x_C + r\cdot\cos\alpha\\
                y_P &= y_C + r\cdot\sin\alpha
            \end{align}
            %
            In \fref{fig:comp-iter-2} the operation has been repeated with $\alpha=\alpha+1$ for 360 times, obtaining the coordinates of 360 $p_n$ points on circle $D$ (the whole set of points is named $P$). Tracing a line between $C$ and any of the points in $P$ will create a segment (in \fref{fig:comp-iter-3} it is named $CP_4$). If an intersection between this segment and the compound's geometry exists, the innermost point is calculated getting its distance from $C$:
            %
            \begin{align}
                \label{eq:innerpoint}
                d_{i_2 C} < d_{i_1 C}
            \end{align}
            %
            Coordinates of $i_2$ ($x_{i_2}, y_{i_2}$) are saved, since it is the nearest. Iterating this process for all the points $p_n\in P$ will create a new set $I$ of $i_n$ points defining the internal side of the compound's geometry. In a last step (not represented in \fref{fig:comp-iter}) a convex hull is generated using all the points in $I$; this is the compound's inner surface.

            \begin{figure}
                \centering
                \begin{subfigure}[b]{.5\columnwidth}
                    \centering
                    \begin{tikzpicture}[x=2.5pt,y=2.5pt,scale=0.09
                            %,overlay,shift={(-500,-65)}
                            ]
                        \input{img/comp-iter-1} 
                    \end{tikzpicture}
                    \caption{$C$, $F$ and $B$ are calculated.}
                    \label{fig:comp-iter-1}
                \end{subfigure}\\
                \vspace{0.03\textheight}
                \begin{subfigure}[b]{.5\columnwidth}
                    \centering
                    \begin{tikzpicture}[x=2.5pt,y=2.5pt,scale=0.09]
                        \input{img/comp-iter-2} 
                    \end{tikzpicture}
                    \caption{Points $P_n$ on $D$, created from $B$.}
                    \label{fig:comp-iter-2}
                \end{subfigure}\\
                \vspace{0.03\textheight}
                \begin{subfigure}[b]{.5\columnwidth}
                    \centering
                    \begin{tikzpicture}[x=2.5pt,y=2.5pt,scale=0.09]
                        \input{img/comp-iter-3} 
                    \end{tikzpicture}
                    \caption{Each $P$: save inner intersection ($i_2$).}
                    \label{fig:comp-iter-3}
                \end{subfigure}\\
                \vspace{0.03\textheight}
                \begin{subfigure}[b]{.5\columnwidth}
                    \centering
                    \begin{tikzpicture}[x=2.5pt,y=2.5pt,scale=0.09
                            %,overlay,shift={(-500,130)}
                            ]
                        \input{img/comp-iter-4} 
                    \end{tikzpicture}
                    \caption{$i_n\in I$ inner intersection points.}
                    \label{fig:comp-iter-4}
                \end{subfigure}

                \caption[Derivation of compound's internal surface using analytical geometry]{Derivation of compound's internal surface in 4 steps, using analytical geometry.}
                \label{fig:comp-iter}
            \end{figure}
            
            A Python algorithm has been used to automate the process, which saves the derived area geometries to a database table separated from the others. Further informations could be derived from these geometries, mostly their perimeter and surface in \si{\meter\squared} (they are saved as attributes). A sample table with the compound's area and attributes is presented in \fref{tab:tab-area-anglisano}. The derived perimeters and areas are useful for a comparison with the results obtained from a manual deriving of the same data % TODO cite angelica
            .

            \begin{table}
                \centering
                \input{tab/tab-area-anglisano}
                \caption[Sample results of area geometries derived from compounds and their attributes for the Anglisano settlement.]{Sample results of the derived area geometries for some compounds in the Anglisano settlement. Rows 1, 4 and 16 represent the same compounds as in \fref{tab:jnb-results}, excepted that the perimeter value is calculated from the area geometry and not from the compound's wall geometry as before (the data are not redundant).}
                \label{tab:tab-area-anglisano}
            \end{table}

        \subsection{Automating discovering of compounds access and orientation}

            The current method used to describe compounds' orientation consists of a visual check of the compound's access position relatively to a set of 8 cardinal points (N, NE, E, SE, S, SW, W, NW) % TODO cite angelica
            . The operator had to visually recognize the orientation of the access and write the relative number (from 1 to 8) as an attribute in a Shapefile's field created on purpose; this lead to manually writing a number for each one of the compounds for all the sites. It is a time-consuming activity that could be automated.

            Literature reports few cases in which orientation has been calculated automatically using GIS methods. In most cases, the analyzed settlements present \emph{houses} more than \emph{compounds}: these have a nearly regular --- mostly rectangular --- shape, in which the orientation can be easily taken as the angle between cardinal north and house's longest axis \cite[p.~53]{spatial-south-europe}. Unfortunately, this is not the case, since compounds have a really irregular shape and in most cases the geometry's longer axis is not meaningful.

            The orientation of an object with respect of a cardinal point can be defined as the angle between the cardinal north and a representative feature of the object (e.g.\ the main axis). When analyzing compounds, this characteristic is the access.

            \subsubsection{Finding the compound's access}

                \begin{wrapfigure}{r}{0.45\textwidth}
                    \centering
                    \begin{tikzpicture}[x=1mm,y=1mm,scale=0.005]
                        \input{tab/dot-flow-access}
                    \end{tikzpicture}
                    \caption[Logic process to determine the compound's access.]{Determination of the compound access. The flow exits when the last point of the $I$ set is reached: $d$ contains the longest side. $T$ means \emph{true}, while $F$ \emph{false}.}
                    \label{fig:flow-access}
                    \vspace{-0.08\textheight}
                \end{wrapfigure}

                The proposed approach depends entirely from the derived areas geometries (\fref{sec:comp-area}): the observation led to consider as an access the longest straight side of the geometry. In other words, the farthest couple of points will identify compound's access (as it is easy to observe in \fref{fig:comp-iter-4}).
                
                The solution consists of an iteration on all the points in the above mentioned $I$ set of points, testing each couple of points for their distance with respect of the previous one. The longest distance is registered. This process is better explained in \fref{fig:flow-access}: starting with a default distance of $d=0$, if the distance between the current point and the next is more than $d$, this value is assigned to $d$ itself. Then, the current point is shifted to the next and the next one is taken, and the process is repeated. When the last point in the $I$ set is reached, $d$ will contain the maximum registered distance (the compound's access).

            \subsubsection{Finding the access orientation}

                Since the access (or doorstep) of a compound is the segment joining the two farthest points in its internal surface, we can derive compound's orientation as the orientation of this segment. Many approaches are possible; we have chosen to calculate the cardinal point that ``contains'' the access; unfortunately, some compounds have a very large access, so we need to reduce the access to a smaller geometry: for this reason we considered the access segment's centroid.

                %\begin{figure}
                \begin{wrapfigure}{r}{0.45\textwidth}
                    \centering
                    \begin{subfigure}[b]{.4\columnwidth}
                        \centering
                        \begin{tikzpicture}[x=2.5pt,y=2.5pt,scale=0.09]
                            \input{img/comp-orient-1} 
                        \end{tikzpicture}
                        \caption{Centroid $e$ is derived from access segment using GIS tools.}
                        \label{fig:comp-orient-1}
                    \end{subfigure}\\
                    \vspace{0.02\textheight}
                    \begin{subfigure}[b]{.4\columnwidth}
                        \centering
                        \begin{tikzpicture}[x=2.5pt,y=2.5pt,scale=0.09]
                            \input{img/comp-orient-2}
                        \end{tikzpicture}
                        \caption{Cardinal points with $\alpha=\sfrac{360}{8}=\SI{45}{\degree}$, built from $B$.}
                        \label{fig:comp-orient-2}
                    \end{subfigure}
                    \vspace{0.02\textheight}
                    \begin{subfigure}[b]{.4\columnwidth}
                        \centering
                        \begin{tikzpicture}[x=2.5pt,y=2.5pt,scale=0.09]
                            \input{img/comp-orient-3}
                        \end{tikzpicture}
                        \caption{$e$ is contained in $W$ area.}
                        \label{fig:comp-orient-3}
                    \end{subfigure}
                    \vspace{0.02\textheight}
                    \begin{subfigure}[b]{.4\columnwidth}
                        \centering
                        \begin{tikzpicture}[x=2.5pt,y=2.5pt,scale=0.09]
                            \input{img/comp-orient-4}
                        \end{tikzpicture}
                        \caption{An numerical index is assigned to every cardinal point (in this case, $W=4$.}
                        \label{fig:comp-orient-4}
                    \end{subfigure}

                    \caption[Graphical rapresentation of the steps to derive compound's access orientation.]{Derivation of the orientation for a single compound's access segment. While $a_1, a_2 \in I$, $e$ is derived using GIS.}
                    \label{fig:comp-orient}
                \end{wrapfigure}

                The calculation consisted in building an octagon using the 8 above mentioned cardinal points as sides. Every triangular slice of the octagon represents the area for that cardinal point. Then, a simple \emph{spatial} check of which triangle contains the access segment's centroid allows to define the orientation of the access. This process details are represented in \fref{fig:comp-orient}: the buffered point $B$ (see \fref{fig:comp-iter-1}) is used to draw points in \fref{fig:comp-orient-2}; a generic cardinal point $p$ is calculated as:
                %
                \begin{align}
                    \label{eq:point-cardinal}
                    x_P &= x_C + d_{(C,B)}\cdot\cos{(\SI{360}{\degree}/8)}\\
                    y_P &= y_C + d_{(C,B)}\cdot\sin{(\SI{360}{\degree}/8)}
                \end{align}
                %
                in a way similar to \fref{eq:point-circle}. The last step, in \fref{fig:comp-orient-3} uses a standard \emph{contains} GIS function to determine in which triangle the centroid $e$ is contained, iterating over all triangles; the example returns a western orientation.

                To store the results, a new table is created; for each compounds the table registers the original Shapefile's ID, the compound's ID, the length of the access segment (automatically calculated as $d_{(a_1, a_2)}$, and the orientation (as number from $0$ to $7$). Sample results for the Anglisano settlements are shown in \fref{tab:tab-access-anglisano}.
                %
                \begin{table}
                    \centering
                    \input{tab/tab-access-anglisano}
                    \caption[Sample results of access calculations for the compounds in the Anglisano settlement.]{Sample results of access calculations for the compounds in the Anglisano settlement.}
                    \label{tab:tab-access-anglisano}
                \end{table}

        %\subsection{Inner/outer compounds}
